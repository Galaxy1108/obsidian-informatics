---
时间: 2025-03-25
tags:
  - 数学
---
[[problems.pdf#page=4|problem]]

我们设
- $f(x)$ 为数组第 $x$ 元素前面有几个比他大的元素
- 设将数字 $x$ 放入位置 $idx_x$

首先，我们考虑冒泡排序做了些什么。由每次交换都是在减少逆序对我们得到，每次冒泡排序做的事情就是
$$
f(x)=
\begin{cases}
0 & f(x)=0 \\
f(x)-1 & f(x)>0
\end{cases}
$$
那么，冒泡排序进行的次数取决于 $\max{\{f(x) | 1 \le x \le n\}}$，那么我们的问题就转换为了
- 有多少个大小为 $N$ 的排列，使得  $\max{\{f(x) | 1 \le x \le n\}}=K$ 

接下来我们考虑这个问题，但是这个问题太难了，因此我们先考虑问题
- 有多少个大小为 $N$ 的排列，使得  $\max{\{f(x) | 1 \le x \le n\}}\le K$
我们思考如何构造，显然我们需要从小到大的进行排列数字，这样使得后面插入的数字不影响前面的数

首先考虑数字 $1$，由于 $\max{\{f(x) | 1 \le x \le n\}}\le K$，所以有 $f(idx_1) \le K$
由于所有数字都比 $1$ 大，即有 $f(idx_1)=idx_1-1$，$idx_1 \le K+1$，$idx_1$ 有 $K+1$ 种取法

然后考虑数字 $2$，我们考虑一个 $2$ 到 $N$ 的序列，显然 $2$ 在这个序列内部也有 $K+1$ 种取法，且 $1$ 不管插入 $1$ 到 $K+1$ 的哪个位置都不影响除了 $1$ 以外的 $f(x)$ 值，又 $f(idx_1) \le K$，所有 $2$ 在这个序列中的取法就象征着在原序列中的取法

依次类推，显然在 序列不足 $K+1$ 个元素前，每个数都有 $K+1$ 种取法，即有 ${(K+1)}^{N-K}$ 种取法，而在序列只剩下 $1$ 至 $K$ 时，显然无论如何排列都是合法的，即有 $K!$ 种取法。

由此可得，有 $K!{(K+1)}^{N-K}$ 个大小为 $N$ 的排列，使得  $\max{\{f(x) | 1 \le x \le n\}}\le K$

那么我们该如何计算有多少个大小为 $N$ 的排列，使得  $\max{\{f(x) | 1 \le x \le n\}}=K$ 呢？
我们设 $T(K)$ 为满足 大小为 $N$ 的，$\max{\{f(x) | 1 \le x \le n\}}\le K$ 的排列个数，显然答案为 $T(K)-T(K-1)$

又由于 $T(K)=K!{(K+1)}^{N-K}$，所以我们得到答案为 
$$
K!{(K+1)}^{N-K}-(K-1)!{(K)}^{N-K+1}
$$
写快速幂，预处理一下 $K!$ 的结果即可快速得到答案

![[2025.03.22_T3.cpp]]

~~%一下HasNoName~~
